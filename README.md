# The Coastal Cliffs Morphology Analysis Toolbox (CCMORPH)

The toolbox is series of Python scripts accompanied with JavaScript tool that can be utilized to analyse dynamics of coastal cliffs based on DEM from different sources such as GPS-RTK, UAVs, aerial or terrestrial LiDAR scanners. Python scripts are client-based (run locally), while Java Script tool can be run as a server-based application (in a web-browser environment).

The repository includes Python tools for automatic analysis of input data (generator-py, shaper-py and analyser-py), a web tool that allows manual correction of selected coastal characteristic points (base and top of the profile), and sample data and configurations demonstrating how the tools work.


## __Tools__

## ```generator-py```

The program is used to generate elevation profiles based on a given coastal DEM file (geotiff), a specified shoreline (shp line) and a trimming area (shp polygon). Basic parameters such as input and output data paths or transect parameters (lengths and spacing) can be set in the config.json file.

The final results and as well as all intermediate results are saved. Those that can be used, for example, by shaper-py, analyzer-py or click-the-coast-js in the form of separate files (separate directory structure), part in the GeoPackage database.

What does the program do?
1. validates input data
2. creates or cleans directories for output and intermediate data
3. initializes the database
4. generates transects based on shoreline (```data/input/coast```)
5. creates buffers around transects and cuts for each buffer a DEM based on the overall image (```data/input/dem```)
6. generates elevation profiles from transects and trimmed DEM models
7. trims the profiles to the specified area (```data/input/crop```) and saves them (```data/output/profiles/cropped```)
8. saves data for profile visualization in click-the-coast-js web application (```data/output/web/geotif```, ```data/output/web/geojdon```, ```data/output/web/names```)

### configuration

The default configuration of the program can be changed by editing the ```generator-py/config.json``` file. Among other things, we can specify:
- directory paths for input data,
- directory paths for output data,
- the path to the database,
- parameters of generated transects,
- parameters of layers in the database (names, crs, ...), etc.

## ```shaper-py```

The program allows you to automatically determine the base and the top of the cliff on each profile automatically, with one of two methodologies: (1) by approximating the distance between shoreline and the cliff top and (2) by identifying the first and second derivative of the cliff profile. Basic parameters, such as paths or method type, can be set in the config.json file.

### What does the program do?
1. reads the trimmed profiles generated by generator-py (```data/output/profiles/cropped```)
2. finds the base and peak on the profiles (choose one of the methods described in the article)
3. saves shaper.csv results to two directories (```data/output/results``` and ```data/output/web/results```)
4. optionally saves calculation details for each profile for method 1 (```data/output/debug```) 

### configuration

- paths to the input data,
- paths to output data,
- the selected method of determining points (1 or 2),
- optional profile smoothing parameters,
- optional debug parameters,
etc.

## ```click-the-coast-js```

A web application that visualizes elevation profiles in which the base and peak could not be automatically determined. It allows you to manually indicate both parameters of the profile. The profile is displayed as a line on the map (top view) and an intersection (side view). Basic parameters, such as paths, can be set in ```scripts/config.js``` file).

### What does the program do?
1. reads profile names generated by generator-py (```data/output/web/names/names.json```)
2. reads trimmed profiles (```output/web/geojson```) and BBOXes (```data/output/web/geotiff```)
3. reads information about profiles whose base and peak have already been automatically determined by shaper-py (```data/output/results/shaper.csv```)
4. visualizes profiles without designated bases and peaks and allows you to manually indicate them
5. saves the results to a csv file (```data/output/web/results/manual.csv```)

**NOTE:** Click-the-coast-js is a web application and requires PHP, among other things, to work. Since it can only refer to the directory in which it is placed, so the necessary data must be copied to and from it. The easiest way is to move a piece of the ```data/output/web``` directory hierarchy to the application directory. Remember to cpoy the later received manual.csv file to the original results directory!

### configuration

The default configuration can be changed by editing the ```click-the-coast-js/scripts/config.js``` file. Among other things, you can set in it:
- path to the directory with profiles,
- path to the directory with bbox files,
- path to the file with profile names,
- map parameters,
etc.

## ```analyzer-py```

The program collects information about the bases and peaks of profiles (generated automatically and indicated manually) and calculates such properties as distance, slope and volume for them. Parameters to be set in the ```config.json``` file.

### What does the program do?
1. reads the trimmed profiles generated by generator-py (```data/output/profiles/cropped```)
2. reads information about profiles whose base and peak have already been automatically determined by shaper-py (```data/output/web/results/shaper.csv```)
3. reads the results of click-the-coast-js, i.e. bases and peaks determined manually (```data/output/web/results/manual.csv``` - remember to copy this file after using click-the-coast-js from the web application's data directory)
4. determines profile parameters (distance, slope, volume) for designated bases and peaks
5. saves the results in a csv file (```data/output/finall```)
6. saves lists of peaks and bases separately to shp files (```data/output/finall```)

### configuration

- paths to the input data,
- paths to output data,
- format of csv file with results from shaper-py,
etc.


## Requirements and initialisation

Most of the tests (both tools and auxiliary scripts) were performed on Linux Ubuntu 22.04.1 LTS using WSL2 running on Windows 11 Pro. The operation of the tools themselves was also tested on macOS Big Sur 11.7.1 and Windows 11 Pro. The Python interpreter version 3.10 was used each time, and the versions of the individual packages can be found in the requirements file.

The systems required the GDAL and Rtree tools to be installed. For Linux Ubuntu, this can be done as follows:
```
sudo apt install gdal-bin libgdal-dev python3-rtree
```

It is recommended that you use the Python Virtual Environment. This protects against version conflicts of previously installed packages. The easiest way to create and activate a virtual environment for testing is to call the following commands (Linux system) in the project root directory:

```
python3 -m venv env
source env/bin/activate
```

Install the necessary packages using the information in the requirements.txt file. Note that we must remember to enter the correct version of the previously installed GDAL tool in this file. So first check the version:

```
gdalinfo --version
```

then edit the requirements.txt file, modifying the GDAL version stored there to the version obtained in the previous step (e.g. GDAL==3.4.1). Finally, install the required packages:

```
pip install -r requirements.txt
```

In the root directory of the project, you can find the ```init.sh ```script, which, when run, performs all the above steps. It has been prepared for use on Ubuntu Linux.

```
./init.sh
```

## Examples

Once the environment has been initialised (e.g. using the ```init.sh``` script), we can start testing the tools. Two sets of test data (same area, different periods) and scripts have been prepared for this purpose. The scripts are used to:
- unpack and copy the input data,
- prepare the configuration for the individual tools,
- run the generator-py, shaper-py and analyser-py tools in turn.

Two such scripts can be found in the root directory of the project: ```example_2011.sh``` and ```example_2017.sh```. These are designed to run the examples in a Linux environment. Running the first script:

```
./example_2011.sh
```

should produce the directory ```example_2011_data```.  The directory will contain the input data, intermediate results and (after the tools have finished running) the final results. For the input data and configuration given in the example, we should get information about 19 profiles on the analysed shoreline section:
- ```example_2011_data/output/finall/measurement_method_2.csv``` (profile data),
- ```example_2011_data/output/finall/bottomPoints/bottomPoints.shp``` (points on profiles which are the base of a dune or cliff),
- ```example_2011_data/output/finall/topPoints/topPoints.shp``` (points on profiles which are the top of a dune or cliff).

Running the script also copies the configuration files prepared for the example data into the ```generator-py```, ```shaper-py``` and ```analyser-py``` directories. We can modify these to change the behaviour of the tools. For example, a change in the ```generator-py/config.json``` file:

```
"transect": {
    "distance": 50,
```

to:

```
"transect": {
    "distance": 20,
```

will result in transects being generated every 20 metres rather than 50 metres. However, the change in the ```shaper-py/config.json``` file from:

```
"method": 2,
```

to:

```
"method": 1,
```

will allow the bases and tops to be determined using method 1 instead of method 2 (see description of shaper-py). Restarting the calculation for the changed configurations, without overwriting the input data, is done by calling the example script with the ```--recount``` parameter

```
./example_2011.sh --recount
```

In a similar way, we can test the tools' actions on a second data set - we use the ```example_2017.sh``` script for this. Note that this time the points are determined using method 1.

## Notes

Most common problems:
- no Rtree tool installed on the system,
- no GDAL tool installed on the system,
- different versions of the system GDAL tool and the GDAL package for Python,
- incorrectly entered paths to data in configuration files,
- incorrectly prepared shp with coastline (wrong direction),
- incorrect datum.
